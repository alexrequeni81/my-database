<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repuestos desde MongoDB</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        #searchInput {
            padding: 10px;
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        form {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        form input[type="text"],
        form input[type="number"] {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            flex: 1 1 calc(50% - 20px);
            max-width: 400px;
        }

        form button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #28a745;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        form button:hover {
            background-color: #218838;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
        }

        th {
            background-color: #007bff;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        td {
            border-bottom: 1px solid #ddd;
        }

        tr:last-child td {
            border-bottom: none;
        }

        button {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            opacity: 0.9;
        }

        button:nth-child(1) {
            background-color: #ffc107;
            color: white;
        }

        button:nth-child(2) {
            background-color: #dc3545;
            color: white;
        }

        .pagination {
            margin-top: 20px;
        }

        .pagination button {
            margin: 0 5px;
            background-color: #007bff;
            color: white;
        }

        .pagination button[disabled] {
            background-color: #ccc;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            form input[type="text"],
            form input[type="number"] {
                flex: 1 1 100%;
            }

            th, td {
                padding: 8px 10px;
            }
        }

        @media (max-width: 480px) {
            table, thead, tbody, th, td, tr {
                display: block;
                width: 100%;
            }

            thead tr {
                display: none;
            }

            td {
                text-align: right;
                padding-left: 50%;
                position: relative;
            }

            td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: calc(50% - 20px);
                padding-right: 10px;
                text-align: left;
                font-weight: bold;
            }
        }
    </style>
</head>
<body>
    <h1>Lista de Repuestos</h1>

    <input type="text" id="searchInput" placeholder="Buscar repuestos..." onkeyup="buscarRepuestos()">

    <form id="addPartForm">
        <input type="text" id="addReferencia" placeholder="Referencia" required>
        <input type="text" id="addDescripcion" placeholder="Descripción" required>
        <input type="text" id="addMaquina" placeholder="Máquina" required>
        <input type="text" id="addGrupo" placeholder="Grupo" required>
        <input type="text" id="addComentario" placeholder="Comentario" required>
        <input type="number" id="addCantidad" placeholder="Cantidad" required>
        <button type="button" onclick="crearRepuesto()">Añadir Repuesto</button>
    </form>

    <div id="error"></div>
    <table id="partsTable">
        <thead>
            <tr>
                <th>REFERENCIA</th>
                <th>DESCRIPCIÓN</th>
                <th>MÁQUINA</th>
                <th>GRUPO</th>
                <th>COMENTARIO</th>
                <th>CANTIDAD</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            <!-- Los datos se insertarán aquí -->
        </tbody>
    </table>

    <!-- Controles de Paginación -->
    <div class="pagination">
        <button id="prevPage" onclick="cambiarPagina(-1)">Anterior</button>
        <span id="pageInfo"></span>
        <button id="nextPage" onclick="cambiarPagina(1)">Siguiente</button>
    </div>

    <script>
        let currentPage = 1;
        const limit = 10;

        function cargarDatos(page = 1) {
            fetch(`/api/parts?page=${page}&limit=${limit}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la respuesta de la API: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    const tableBody = document.querySelector('#partsTable tbody');
                    tableBody.innerHTML = '';

                    if (data.parts.length === 0) {
                        document.getElementById('error').innerText = 'No se encontraron repuestos en la base de datos.';
                    } else {
                        data.parts.forEach(part => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td data-label="REFERENCIA">${part.REFERENCIA}</td>
                                <td data-label="DESCRIPCIÓN">${part.DESCRIPCIÓN}</td>
                                <td data-label="MÁQUINA">${part.MÁQUINA}</td>
                                <td data-label="GRUPO">${part.GRUPO}</td>
                                <td data-label="COMENTARIO">${part.COMENTARIO}</td>
                                <td data-label="CANTIDAD">${part.CANTIDAD}</td>
                                <td>
                                    <button onclick="editarRepuesto('${part._id}')">Editar</button>
                                    <button onclick="eliminarRepuesto('${part._id}')">Eliminar</button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    }

                    // Actualizar la información de la paginación
                    document.getElementById('pageInfo').innerText = `Página ${data.page} de ${data.pages}`;
                    document.getElementById('prevPage').disabled = data.page === 1;
                    document.getElementById('nextPage').disabled = data.page === data.pages;
                    currentPage = data.page;
                })
                .catch(error => {
                    console.error('Error al cargar los repuestos:', error);
                    document.getElementById('error').innerText = 'Error al cargar los repuestos: ' + error.message;
                });
        }

        function cambiarPagina(incremento) {
            cargarDatos(currentPage + incremento);
        }

        cargarDatos();

        function crearRepuesto() {
            const newPart = {
                REFERENCIA: document.getElementById('addReferencia').value,
                DESCRIPCIÓN: document.getElementById('addDescripcion').value,
                MÁQUINA: document.getElementById('addMaquina').value,
                GRUPO: document.getElementById('addGrupo').value,
                COMENTARIO: document.getElementById('addComentario').value,
                CANTIDAD: document.getElementById('addCantidad').value,
            };

            fetch('/api/parts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newPart)
            })
            .then(response => response.json())
            .then(data => {
                location.reload();
            })
            .catch(error => {
                console.error('Error al crear el repuesto:', error);
            });
        }

        function editarRepuesto(id) {
            const updatedPart = {
                REFERENCIA: prompt("Editar Referencia:"),
                DESCRIPCIÓN: prompt("Editar Descripción:"),
                MÁQUINA: prompt("Editar Máquina:"),
                GRUPO: prompt("Editar Grupo:"),
                COMENTARIO: prompt("Editar Comentario:"),
                CANTIDAD: prompt("Editar Cantidad:")
            };

            fetch(`/api/parts/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedPart)
            })
            .then(response => response.json())
            .then(() => {
                location.reload();
            })
            .catch(error => {
                console.error('Error al actualizar el repuesto:', error);
            });
        }

        function eliminarRepuesto(id) {
            if (confirm('¿Estás seguro de que deseas eliminar este repuesto?')) {
                fetch(`/api/parts/${id}`, {
                    method: 'DELETE'
                })
                .then(() => {
                    location.reload();
                })
                .catch(error => {
                    console.error('Error al eliminar el repuesto:', error);
                });
            }
        }
    </script>
</body>
</html>
